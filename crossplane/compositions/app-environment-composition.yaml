apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: appenvironment.platform.openco.tech
spec:
  compositeTypeRef:
    apiVersion: platform.openco.tech/v1alpha1
    kind: AppEnvironment
  mode: Pipeline
  pipeline:
    - step: patch-and-transform
      functionRef:
        name: function-patch-and-transform
      input:
        apiVersion: pt.fn.crossplane.io/v1beta1
        kind: Resources
        resources:
          # 1. Create GCPProject XR
          - name: gcp-project-xr
            base:
              apiVersion: platform.openco.tech/v1alpha1
              kind: GCPProject
            patches:
              - fromFieldPath: spec.appName
                toFieldPath: spec.appName
              - fromFieldPath: spec.environment
                toFieldPath: spec.environment
              - fromFieldPath: spec.teamId
                toFieldPath: spec.teamId
              - fromFieldPath: spec.costCenter
                toFieldPath: spec.costCenter
              - type: ToCompositeFieldPath
                fromFieldPath: status.projectId
                toFieldPath: status.projectId
            readinessChecks:
              - type: MatchCondition
                matchCondition:
                  type: Ready
                  status: "True"

          # 3. Create GCPArtifact XR
          - name: gcp-artifact-xr
            base:
              apiVersion: platform.openco.tech/v1alpha1
              kind: GCPArtifact
            patches:
              - fromFieldPath: spec.appName
                toFieldPath: spec.appName
              - fromFieldPath: spec.region
                toFieldPath: spec.region
              - fromFieldPath: spec.teamId
                toFieldPath: spec.teamId
              - fromFieldPath: spec.environment
                toFieldPath: spec.environment
              - fromFieldPath: spec.costCenter
                toFieldPath: spec.costCenter
              - fromFieldPath: status.projectId
                toFieldPath: spec.projectId
              - type: ToCompositeFieldPath
                fromFieldPath: status.repositoryUrl
                toFieldPath: status.artifactRegistryUrl
            readinessChecks:
              - type: MatchCondition
                matchCondition:
                  type: Ready
                  status: "True"

          # 4. Create GCPSecretManager XR
          - name: gcp-secretmanager-xr
            base:
              apiVersion: platform.openco.tech/v1alpha1
              kind: GCPSecretManager
            patches:
              - fromFieldPath: spec.appName
                toFieldPath: spec.appName
              - fromFieldPath: status.projectId
                toFieldPath: spec.projectId
              - fromFieldPath: spec.secretManager.secrets
                toFieldPath: spec.secrets
            readinessChecks:
              - type: MatchCondition
                matchCondition:
                  type: Ready
                  status: "True"

          # 5. Create GCPCloudRun XR
          - name: gcp-cloudrun-xr
            base:
              apiVersion: platform.openco.tech/v1alpha1
              kind: GCPCloudRun
            patches:
              - fromFieldPath: spec.appName
                toFieldPath: spec.appName
              - fromFieldPath: spec.region
                toFieldPath: spec.region
              - fromFieldPath: spec.teamId
                toFieldPath: spec.teamId
              - fromFieldPath: spec.environment
                toFieldPath: spec.environment
              - fromFieldPath: status.projectId
                toFieldPath: spec.projectId
              - fromFieldPath: status.serviceAccountEmail
                toFieldPath: spec.serviceAccountEmail
              - fromFieldPath: spec.cloudRun.port
                toFieldPath: spec.port
              - type: ToCompositeFieldPath
                fromFieldPath: status.serviceUrl
                toFieldPath: status.cloudRunUrl
            readinessChecks:
              - type: MatchCondition
                matchCondition:
                  type: Ready
                  status: "True"

    - step: sequence-resources
      functionRef:
        name: function-sequencer
      input:
        apiVersion: sequencer.fn.crossplane.io/v1beta1
        kind: Input
        rules:
          - sequence:
              - gcp-project-xr
              - gcp-artifact-xr
          - sequence:
              - gcp-project-xr
              - gcp-secretmanager-xr
          - sequence:
              - gcp-project-xr
              - gcp-cloudrun-xr

    - step: status-handler
      functionRef:
        name: function-status-transformer
      input:
         apiVersion: function-status-transformer.fn.crossplane.io/v1beta1
         kind: StatusTransformation
         statusConditionHooks:
           # 1. GCPProject XR - Detect failures or not-ready status
           - matchers:
               - resources:
                   - name: "gcp-project-xr"
                 conditions:
                   - type: Synced
                     status: "False"
                   - type: Ready
                     status: "False"
                 type: AnyResourceMatchesAnyCondition
             setConditions:
               - target: CompositeAndClaim
                 condition:
                   type: Ready
                   status: "False"
                   reason: ProjectFailed
                   message: "GCP Project is unhealthy - check GCPProject resource status"
             createEvents:
               - target: CompositeAndClaim
                 event:
                   type: Warning
                   reason: ProjectFailed
                   message: "GCP Project failed or not ready"

           # 2. GCPArtifact XR - Detect failures or not-ready status
           - matchers:
               - resources:
                   - name: "gcp-artifact-xr"
                 conditions:
                   - type: Synced
                     status: "False"
                   - type: Ready
                     status: "False"
                 type: AnyResourceMatchesAnyCondition
             setConditions:
               - target: CompositeAndClaim
                 condition:
                   type: Ready
                   status: "False"
                   reason: ArtifactFailed
                   message: "Artifact Registry is unhealthy - check GCPArtifact resource status"
             createEvents:
               - target: CompositeAndClaim
                 event:
                   type: Warning
                   reason: ArtifactFailed
                   message: "Artifact Registry failed or not ready"

           # 3. GCPSecretManager XR - Detect failures or not-ready status
           - matchers:
               - resources:
                   - name: "gcp-secretmanager-xr"
                 conditions:
                   - type: Synced
                     status: "False"
                   - type: Ready
                     status: "False"
                 type: AnyResourceMatchesAnyCondition
             setConditions:
               - target: CompositeAndClaim
                 condition:
                   type: Ready
                   status: "False"
                   reason: SecretManagerFailed
                   message: "Secret Manager is unhealthy - check GCPSecretManager resource status"
             createEvents:
               - target: CompositeAndClaim
                 event:
                   type: Warning
                   reason: SecretManagerFailed
                   message: "Secret Manager failed or not ready"

           # 4. GCPCloudRun XR - Detect failures or not-ready status
           - matchers:
               - resources:
                   - name: "gcp-cloudrun-xr"
                 conditions:
                   - type: Synced
                     status: "False"
                   - type: Ready
                     status: "False"
                 type: AnyResourceMatchesAnyCondition
             setConditions:
               - target: CompositeAndClaim
                 condition:
                   type: Ready
                   status: "False"
                   reason: CloudRunFailed
                   message: "Cloud Run is unhealthy - check GCPCloudRun resource status"
             createEvents:
               - target: CompositeAndClaim
                 event:
                   type: Warning
                   reason: CloudRunFailed
                   message: "Cloud Run failed or not ready"

           # 5. All child XRs healthy - Set success condition (placed LAST to override failures with force: true)
           - matchers:
               - resources:
                   - name: "gcp-project-xr"
                 conditions:
                   - type: Ready
                     status: "True"
               - resources:
                   - name: "gcp-artifact-xr"
                 conditions:
                   - type: Ready
                     status: "True"
               - resources:
                   - name: "gcp-secretmanager-xr"
                 conditions:
                   - type: Ready
                     status: "True"
               - resources:
                   - name: "gcp-cloudrun-xr"
                 conditions:
                   - type: Ready
                     status: "True"
             setConditions:
               - target: CompositeAndClaim
                 force: true
                 condition:
                   type: Ready
                   status: "True"
                   reason: AllResourcesReady
                   message: "All application resources are healthy and operational"
             createEvents:
               - target: CompositeAndClaim
                 event:
                   type: Normal
                   reason: AppEnvironmentReady
                   message: "Application environment fully provisioned and ready"

    - step: auto-ready
      functionRef:
        name: function-auto-ready
