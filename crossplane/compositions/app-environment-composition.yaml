apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: appenvironment.platform.openco.tech
spec:
  compositeTypeRef:
    apiVersion: platform.openco.tech/v1alpha1
    kind: AppEnvironment
  mode: Pipeline
  pipeline:
    - step: patch-and-transform
      functionRef:
        name: function-patch-and-transform
      input:
        apiVersion: pt.fn.crossplane.io/v1beta1
        kind: Resources
        resources:
          # 1. Create GCPProject XR
          - name: gcp-project-xr
            base:
              apiVersion: platform.openco.tech/v1alpha1
              kind: GCPProject
            patches:
              - fromFieldPath: spec.appName
                toFieldPath: spec.appName
              - fromFieldPath: spec.environment
                toFieldPath: spec.environment
              - fromFieldPath: spec.teamId
                toFieldPath: spec.teamId
              - fromFieldPath: spec.costCenter
                toFieldPath: spec.costCenter
              - type: ToCompositeFieldPath
                fromFieldPath: status.projectId
                toFieldPath: status.projectId
            readinessChecks:
              - type: MatchCondition
                matchCondition:
                  type: Ready
                  status: "True"

          # 3. Create GCPArtifact XR
          - name: gcp-artifact-xr
            base:
              apiVersion: platform.openco.tech/v1alpha1
              kind: GCPArtifact
            patches:
              - fromFieldPath: spec.appName
                toFieldPath: spec.appName
              - fromFieldPath: spec.region
                toFieldPath: spec.region
              - fromFieldPath: spec.teamId
                toFieldPath: spec.teamId
              - fromFieldPath: spec.environment
                toFieldPath: spec.environment
              - fromFieldPath: spec.costCenter
                toFieldPath: spec.costCenter
              - fromFieldPath: status.projectId
                toFieldPath: spec.projectId
              - type: ToCompositeFieldPath
                fromFieldPath: status.repositoryUrl
                toFieldPath: status.artifactRegistryUrl
            readinessChecks:
              - type: MatchCondition
                matchCondition:
                  type: Ready
                  status: "True"

          # 4. Create GCPSecretManager XR
          - name: gcp-secretmanager-xr
            base:
              apiVersion: platform.openco.tech/v1alpha1
              kind: GCPSecretManager
            patches:
              - fromFieldPath: spec.appName
                toFieldPath: spec.appName
              - fromFieldPath: status.projectId
                toFieldPath: spec.projectId
              - fromFieldPath: spec.secretManager.secrets
                toFieldPath: spec.secrets
            readinessChecks:
              - type: MatchCondition
                matchCondition:
                  type: Ready
                  status: "True"

          # 5. Create GCPCloudRun XR
          - name: gcp-cloudrun-xr
            base:
              apiVersion: platform.openco.tech/v1alpha1
              kind: GCPCloudRun
            patches:
              - fromFieldPath: spec.appName
                toFieldPath: spec.appName
              - fromFieldPath: spec.region
                toFieldPath: spec.region
              - fromFieldPath: spec.teamId
                toFieldPath: spec.teamId
              - fromFieldPath: spec.environment
                toFieldPath: spec.environment
              - fromFieldPath: status.projectId
                toFieldPath: spec.projectId
              - fromFieldPath: status.serviceAccountEmail
                toFieldPath: spec.serviceAccountEmail
              - fromFieldPath: spec.cloudRun.port
                toFieldPath: spec.port
              - type: ToCompositeFieldPath
                fromFieldPath: status.serviceUrl
                toFieldPath: status.cloudRunUrl
            readinessChecks:
              - type: MatchCondition
                matchCondition:
                  type: Ready
                  status: "True"

    - step: sequence-resources
      functionRef:
        name: function-sequencer
      input:
        apiVersion: sequencer.fn.crossplane.io/v1beta1
        kind: Input
        rules:
          - sequence:
              - gcp-project-xr
              - gcp-artifact-xr
          - sequence:
              - gcp-project-xr
              - gcp-secretmanager-xr
          - sequence:
              - gcp-project-xr
              - gcp-cloudrun-xr

    - step: status-handler
      functionRef:
        name: function-status-transformer
      input:
        apiVersion: function-status-transformer.fn.crossplane.io/v1beta1
        kind: StatusTransformation
        statusConditionHooks:
            # 1. Default: Provisioning in progress
            - matchers:
                - resources:
                    - name: "gcp-project-xr"
                  conditions:
                    - type: Synced
                      status: "True"
              setConditions:
                - target: CompositeAndClaim
                  condition:
                    type: Developer
                    status: "True"
                    message: "Provisioning infrastructure..."

            # 2. GCPProject - ProviderConfig missing (service owner action required)
            - matchers:
                - resources:
                    - name: "gcp-project-xr"
                  conditions:
                    - type: Synced
                      status: "False"
                      reason: ReconcileError
                      message: "(.*)cannot get referenced ProviderConfig(.*)"
              setConditions:
                - target: CompositeAndClaim
                  force: true
                  condition:
                    type: Developer
                    status: "False"
                    reason: ProviderConfigMissing
                    message: "GCP provider is not configured. Contact platform team."
              createEvents:
                - target: CompositeAndClaim
                  event:
                    type: Warning
                    reason: ProviderConfigMissing
                    message: "GCP provider configuration missing - contact platform team"

            # 3. GCPProject - Invalid region/location (user action required)
            - matchers:
                - resources:
                    - name: "gcp-project-xr"
                  conditions:
                    - type: Synced
                      status: "False"
                      reason: ReconcileError
                      message: "(.*)location '(?P<Region>.*)' is invalid(.*)"
              setConditions:
                - target: CompositeAndClaim
                  force: true
                  condition:
                    type: Developer
                    status: "False"
                    reason: InvalidRegion
                    message: "Region '{{ .Region }}' is not available. Check spec.region value."
              createEvents:
                - target: CompositeAndClaim
                  event:
                    type: Warning
                    reason: InvalidRegion
                    message: "Invalid region specified - check your region configuration"

            # 4. GCPProject - Permission denied (service owner action required)
            - matchers:
                - resources:
                    - name: "gcp-project-xr"
                  conditions:
                    - type: Synced
                      status: "False"
                      reason: ReconcileError
                      message: "(.*)permission denied(.*)|(.*)[Pp]ermission(.*)denied(.*)"
              setConditions:
                - target: CompositeAndClaim
                  force: true
                  condition:
                    type: Developer
                    status: "False"
                    reason: PermissionDenied
                    message: "Insufficient permissions to create resources. Contact platform team."
              createEvents:
                - target: CompositeAndClaim
                  event:
                    type: Warning
                    reason: PermissionDenied
                    message: "Permission denied creating infrastructure - contact platform team"

            # 5. GCPProject - Resource already exists (user action required)
            - matchers:
                - resources:
                    - name: "gcp-project-xr"
                  conditions:
                    - type: Synced
                      status: "False"
                      reason: ReconcileError
                      message: "(.*)[Aa]lready [Ee]xists(.*)"
              setConditions:
                - target: CompositeAndClaim
                  force: true
                  condition:
                    type: Developer
                    status: "False"
                    reason: AlreadyExists
                    message: "A resource with this name already exists. Check spec.appName value."
              createEvents:
                - target: CompositeAndClaim
                  event:
                    type: Warning
                    reason: AlreadyExists
                    message: "Resource already exists - choose a different name"

            # 6. GCPProject - Generic Synced=False (service owner action required)
            - matchers:
                - resources:
                    - name: "gcp-project-xr"
                  conditions:
                    - type: Synced
                      status: "False"
              setConditions:
                - target: CompositeAndClaim
                  condition:
                    type: Developer
                    status: "False"
                    reason: SyncFailed
                    message: "GCP Project provisioning failed. Contact platform team for assistance."
              createEvents:
                - target: CompositeAndClaim
                  event:
                    type: Warning
                    reason: SyncFailed
                    message: "GCP Project sync failed"

            # 7. GCPArtifact - Any failure
            - matchers:
                - resources:
                    - name: "gcp-artifact-xr"
                  conditions:
                    - type: Synced
                      status: "False"
                    - type: Ready
                      status: "False"
                  type: AnyResourceMatchesAnyCondition
              setConditions:
                - target: CompositeAndClaim
                  force: true
                  condition:
                    type: Developer
                    status: "False"
                    reason: ArtifactFailed
                    message: "Artifact Registry provisioning failed. Contact platform team."
              createEvents:
                - target: CompositeAndClaim
                  event:
                    type: Warning
                    reason: ArtifactFailed
                    message: "Artifact Registry failed"

            # 8. GCPSecretManager - Any failure
            - matchers:
                - resources:
                    - name: "gcp-secretmanager-xr"
                  conditions:
                    - type: Synced
                      status: "False"
                    - type: Ready
                      status: "False"
                  type: AnyResourceMatchesAnyCondition
              setConditions:
                - target: CompositeAndClaim
                  force: true
                  condition:
                    type: Developer
                    status: "False"
                    reason: SecretManagerFailed
                    message: "Secret Manager provisioning failed. Contact platform team."
              createEvents:
                - target: CompositeAndClaim
                  event:
                    type: Warning
                    reason: SecretManagerFailed
                    message: "Secret Manager failed"

            # 9. GCPCloudRun - Any failure
            - matchers:
                - resources:
                    - name: "gcp-cloudrun-xr"
                  conditions:
                    - type: Synced
                      status: "False"
                    - type: Ready
                      status: "False"
                  type: AnyResourceMatchesAnyCondition
              setConditions:
                - target: CompositeAndClaim
                  force: true
                  condition:
                    type: Developer
                    status: "False"
                    reason: CloudRunFailed
                    message: "Cloud Run provisioning failed. Contact platform team."
              createEvents:
                - target: CompositeAndClaim
                  event:
                    type: Warning
                    reason: CloudRunFailed
                    message: "Cloud Run failed"

            # 10. All child XRs healthy - Success condition (placed LAST with force: true)
            - matchers:
                - resources:
                    - name: "gcp-project-xr"
                  conditions:
                    - type: Ready
                      status: "True"
                - resources:
                    - name: "gcp-artifact-xr"
                  conditions:
                    - type: Ready
                      status: "True"
                - resources:
                    - name: "gcp-secretmanager-xr"
                  conditions:
                    - type: Ready
                      status: "True"
                - resources:
                    - name: "gcp-cloudrun-xr"
                  conditions:
                    - type: Ready
                      status: "True"
              setConditions:
                - target: CompositeAndClaim
                  force: true
                  condition:
                    type: Developer
                    status: "True"
                    reason: Ready
                    message: "Application environment fully provisioned and ready"
              createEvents:
                - target: CompositeAndClaim
                  event:
                    type: Normal
                    reason: AppEnvironmentReady
                    message: "Application environment ready for use"

    - step: auto-ready
      functionRef:
        name: function-auto-ready
