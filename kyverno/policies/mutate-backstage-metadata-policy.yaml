apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: mutate-backstage-metadata
  namespace: kyverno
spec:
  validationFailureAction: audit
  background: false
  rules:
    - name: inject-backstage-labels
      match:
        resources:
          kinds:
            - platform.openco.tech/v1alpha1/AppEnvironment
            - platform.openco.tech/v1alpha1/AppComposite
          annotations:
            backstage.io/managed-by: 'scaffolder'
      mutate:
        patchStrategicMerge:
          metadata:
            labels:
              managed-by: backstage
              provisioner: crossplane

    - name: track-git-source
      match:
        resources:
          kinds:
            - platform.openco.tech/v1alpha1/AppEnvironment
            - platform.openco.tech/v1alpha1/AppComposite
      mutate:
        patchStrategicMerge:
          metadata:
            annotations:
              kyverno.io/last-applied-by: '{{request.userInfo.username}}'
