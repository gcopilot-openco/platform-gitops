apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
data:
  application.resourceTrackingMethod: annotation
  resource.exclusions: |
    - apiGroups: ["*"]
      kinds: [ProviderConfigUsage]
  resource.customizations: |
    "*.upbound.io/*":
      health.lua: |
        health_status = {
          status = "Progressing",
          message = "Waiting for resource to be synced and ready..."
        }

        local function contains (table, val)
          for i, v in ipairs(table) do
            if v == val then
              return true
            end
          end
          return false
        end

        local has_no_status = {
          "ClusterProviderConfig",
          "ProviderConfig",
          "ProviderConfigUsage"
        }

        -- Only mark as Healthy if it's a known 'no status' kind and status is empty
        if (obj.status == nil or next(obj.status) == nil) and contains(has_no_status, obj.kind) then
          health_status.status = "Healthy"
          health_status.message = "Resource is up-to-date."
          return health_status
        end

        if obj.status == nil or obj.status.conditions == nil then
          return health_status
        end

        local synced = false
        local ready = false
        local healthy = false

        for i, condition in ipairs(obj.status.conditions) do
          if condition.type == "Synced" then
            if condition.status == "False" then
              health_status.status = "Degraded"
              health_status.message = condition.message
              return health_status
            end
            if condition.status == "True" then synced = true end
          end

          if condition.type == "Ready" or condition.type == "Healthy" then
            if condition.status == "False" then
               -- Note: We don't immediately fail on Ready=False because it might be transient 
               -- but Synced=False is usually a hard configuration error.
            end
            if condition.status == "True" then 
              if condition.type == "Ready" then ready = true end
              if condition.type == "Healthy" then healthy = true end
            end
          end
        end

        if synced and (ready or healthy) then
          health_status.status = "Healthy"
          health_status.message = "Resource is healthy and synced."
        end

        return health_status
    "platform.openco.tech/AppEnvironment":
      health.lua: |
        health_status = {
          status = "Progressing",
          message = "Provisioning infrastructure..."
        }

        if obj.status == nil or obj.status.conditions == nil then
          return health_status
        end

        local synced = false
        local ready = false

        for i, condition in ipairs(obj.status.conditions) do
          if condition.type == "Synced" then
            if condition.status == "False" then
              health_status.status = "Degraded"
              health_status.message = condition.message
              return health_status
            end
            if condition.status == "True" then synced = true end
          end

          if condition.type == "Ready" then
            if condition.status == "False" then
              if condition.message ~= nil and condition.message ~= "" then
                health_status.status = "Degraded"
                health_status.message = condition.message
                return health_status
              end
            end
            if condition.status == "True" then ready = true end
          end
        end

        if synced and ready then
          health_status.status = "Healthy"
          health_status.message = "All infrastructure provisioned successfully."
        end

        return health_status
    "platform.openco.tech/GCPProject":
      health.lua: |
        health_status = {
          status = "Progressing",
          message = "Provisioning GCP project..."
        }

        if obj.status == nil or obj.status.conditions == nil then
          return health_status
        end

        for i, condition in ipairs(obj.status.conditions) do
          if condition.type == "Synced" and condition.status == "False" then
            health_status.status = "Degraded"
            health_status.message = condition.message
            return health_status
          end
          if condition.type == "Ready" and condition.status == "True" then
            health_status.status = "Healthy"
            health_status.message = "GCP project ready."
            return health_status
          end
        end

        return health_status
    "platform.openco.tech/*":
      health.lua: |
        health_status = {
          status = "Progressing",
          message = "Provisioning..."
        }

        if obj.status == nil or obj.status.conditions == nil then
          return health_status
        end

        for i, condition in ipairs(obj.status.conditions) do
          if condition.type == "Synced" and condition.status == "False" then
            health_status.status = "Degraded"
            health_status.message = condition.message
            return health_status
          end
          if condition.type == "Ready" and condition.status == "True" then
            health_status.status = "Healthy"
            health_status.message = "Resource ready."
            return health_status
          end
        end

        return health_status
    "*.crossplane.io/*":
      health.lua: |
        health_status = {
          status = "Progressing",
          message = "Provisioning ..."
        }

        local function contains (table, val)
          for i, v in ipairs(table) do
            if v == val then
              return true
            end
          end
          return false
        end

        local has_no_status = {
          "Composition",
          "CompositionRevision",
          "DeploymentRuntimeConfig",
          "ClusterProviderConfig",
          "ProviderConfig",
          "ProviderConfigUsage"
        }
        if obj.status == nil or next(obj.status) == nil and contains(has_no_status, obj.kind) then
            health_status.status = "Healthy"
            health_status.message = "Resource is up-to-date."
          return health_status
        end

        if obj.status == nil or next(obj.status) == nil or obj.status.conditions == nil then
          if (obj.kind == "ProviderConfig" or obj.kind == "ClusterProviderConfig") and obj.status.users ~= nil then
            health_status.status = "Healthy"
            health_status.message = "Resource is in use."
            return health_status
          end
          return health_status
        end

        for i, condition in ipairs(obj.status.conditions) do
          if condition.type == "LastAsyncOperation" then
            if condition.status == "False" then
              health_status.status = "Degraded"
              health_status.message = condition.message
              return health_status
            end
          end

          if condition.type == "Synced" then
            if condition.status == "False" then
              health_status.status = "Degraded"
              health_status.message = condition.message
              return health_status
            end
          end

          if contains({"Ready", "Offered", "Established", "ValidPipeline", "RevisionHealthy"}, condition.type) then
            if condition.status == "True" then
              health_status.status = "Healthy"
              health_status.message = "Resource is up-to-date."
            end
          end
        end

        return health_status